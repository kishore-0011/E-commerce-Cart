{% extends "product/base.html" %}
{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 relative">
    <h1 class="text-3xl font-bold mb-8">Shopping Cart</h1>

    {% if cart %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Order Summary  -->
        <div class="order-1 lg:order-2 lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
                <h2 class="text-2xl font-bold mb-4">Order Summary</h2>

                <div class="space-y-3 mb-6">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Items (<span id="cart-items-count">{{ cart|length }}</span>)</span>
                        <span class="font-semibold" id="cart-subtotal">₹{{ cart.get_total_price }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Shipping</span>
                        <span class="font-semibold text-green-600">FREE</span>
                    </div>
                    <hr>
                    <div class="flex justify-between text-xl">
                        <span class="font-bold">Total</span>
                        <span class="font-bold text-blue-600" id="cart-total">₹{{ cart.get_total_price }}</span>
                    </div>
                </div>

                <a href="{% url 'shop:checkout' %}" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold mb-3 block text-center">
                    Proceed to Checkout
                </a>

                <a href="{% url 'shop:product_list' %}" class="block w-full text-center bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300">
                    Continue Shopping
                </a>
            </div>
        </div>

        <!-- Cart Items -->
        <div class="order-2 lg:order-1 lg:col-span-2" id="cart-items">
            {% for item in cart %}
            <div class="bg-white rounded-lg shadow-md p-6 mb-4" data-product-id="{{ item.product.id }}">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="w-full md:w-32 h-32 flex-shrink-0">
                        {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-contain rounded">
                        {% else %}
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center rounded">
                            <i class="fas fa-image text-gray-400 text-3xl"></i>
                        </div>
                        {% endif %}
                    </div>

                    <div class="flex-1">
                        <h3 class="text-xl font-semibold mb-2">{{ item.product.name }}</h3>
                        <p class="text-gray-600 text-sm mb-2">{{ item.product.category.name }}</p>
                        <p class="text-blue-600 font-bold text-lg">₹{{ item.price }}</p>
                        <p class="text-sm text-gray-500 mt-1">Available stock: {{ item.product.stock }}</p>
                    </div>

                    <div class="flex flex-col justify-between items-end">
                        <button onclick="removeFromCart({{ item.product.id }})" class="text-red-500 hover:text-red-700 text-xl">
                            <i class="fas fa-trash"></i>
                        </button>

                        <div class="mt-4 flex items-center gap-3">
                            <button onclick="updateQuantity({{ item.product.id }}, 'decrease')" 
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 w-8 h-8 rounded-lg flex items-center justify-center font-bold">
                                <i class="fas fa-minus"></i>
                            </button>

                            <span class="text-xl font-semibold w-12 text-center quantity-{{ item.product.id }}">{{ item.quantity }}</span>

                            <button onclick="updateQuantity({{ item.product.id }}, 'increase')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <div class="mt-4 text-right">
                            <p class="text-sm text-gray-500">Subtotal</p>
                            <p class="text-xl font-bold text-blue-600 item-total-{{ item.product.id }}">₹{{ item.total_price }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {% else %}
    <div class="text-center py-12">
        <i class="fas fa-shopping-cart text-gray-300 text-8xl mb-4"></i>
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Your cart is empty</h2>
        <p class="text-gray-500 mb-6">Start shopping to add items to your cart</p>
        <a href="{% url 'shop:product_list' %}" class="inline-block bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700">
            Browse Products
        </a>
    </div>
    {% endif %}
</div>

<!-- Scroll to Top - Desktop -->
<button id="scrollToTopDesktop"
    onclick="scrollToTop()"
    class="hidden md:flex fixed bottom-8 right-8 bg-blue-600 text-white w-12 h-12 rounded-full shadow-lg items-center justify-center
           hover:bg-blue-700 hover:scale-110 active:scale-95 transition-all duration-300 z-50 opacity-0 pointer-events-none">
    <i class="fas fa-arrow-up text-lg"></i>
</button>

<!-- Scroll to Top - Mobile  -->
<div class="md:hidden mt-4">
    <button onclick="scrollToTop()"
        class="w-full py-4 flex items-center justify-center gap-2 text-white font-semibold bg-blue-600 hover:bg-blue-700">
        <i class="fas fa-arrow-up text-lg"></i>
        <span>Back to Top</span>
    </button>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++){
            const cookie = cookies[i].trim();
            if (cookie.substring(0,name.length+1)=== (name+'=')){
                cookieValue = decodeURIComponent(cookie.substring(name.length+1));
                break;
            }
        }
    }
    return cookieValue;
}

// Update Quantity
function updateQuantity(productId, action){
    const csrftoken = getCookie('csrftoken');
    const formData = new FormData();
    formData.append('action', action);

    fetch(`/cart/update/${productId}/`,{
        method:'POST',
        headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken},
        body: formData
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            document.querySelector(`.quantity-${productId}`).textContent = data.quantity;
            document.querySelector(`.item-total-${productId}`).textContent = '₹'+data.item_total;
            document.getElementById('cart-subtotal').textContent = '₹'+data.cart_total;
            document.getElementById('cart-total').textContent = '₹'+data.cart_total;
            document.getElementById('cart-items-count').textContent = data.cart_count;
            document.getElementById('cart-count').textContent = data.cart_count;
        }else{ showAlert(data.error,'error'); }
    }).catch(()=>showAlert('Error updating cart','error'));
}

// Remove from Cart
function removeFromCart(productId){
    const csrftoken = getCookie('csrftoken');

    fetch(`/cart/remove/${productId}/`,{
        method:'POST',
        headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken}
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            const el = document.querySelector(`[data-product-id="${productId}"]`);
            el.style.transition='opacity 0.3s';
            el.style.opacity='0';
            setTimeout(()=>{
                el.remove();
                if(data.cart_count===0) location.reload();
                else{
                    document.getElementById('cart-subtotal').textContent='₹'+data.cart_total;
                    document.getElementById('cart-total').textContent='₹'+data.cart_total;
                    document.getElementById('cart-items-count').textContent=data.cart_count;
                    document.getElementById('cart-count').textContent=data.cart_count;
                }
            },300);
            showAlert(`${data.product_name} removed from cart!`,'success');
        }
    }).catch(()=>showAlert('Error removing from cart','error'));
}

// Scroll to Top
function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }

window.addEventListener('scroll', function(){
    const desktopBtn = document.getElementById('scrollToTopDesktop');
    const scrollY = window.scrollY;
    const footer = document.querySelector('footer');
    const windowHeight = window.innerHeight;
    const footerTop = footer ? footer.getBoundingClientRect().top + window.scrollY : Infinity;

    // Show desktop button after scrolling 300px
    if(scrollY>300){
        desktopBtn.classList.remove('opacity-0','pointer-events-none');
        desktopBtn.classList.add('opacity-100');
    } else {
        desktopBtn.classList.add('opacity-0','pointer-events-none');
        desktopBtn.classList.remove('opacity-100');
    }

    // Stop desktop button overlapping footer
    if(footer && scrollY + windowHeight > footerTop){
        const offset = (scrollY + windowHeight) - footerTop + 16; 
        desktopBtn.style.bottom = `${offset}px`;
    } else {
        desktopBtn.style.bottom = '2rem';
    }
});
</script>
{% endblock %}